<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - NIO</title>
    
    <link rel="shortcut icon" href="img/favicon1.png" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/estilo.css">
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    
    <style>
        /* Ajustes espec√≠ficos do Painel */
        @media (min-width: 993px) {
            .navbar-menu-center { position: absolute; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; }
        }
        @media (max-width: 992px) {
            .navbar-menu-center { display: flex; gap: 15px; font-size: 0.9rem; margin-top: 5px; width: 100%; justify-content: center; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; }
            .navbar-container { flex-wrap: wrap; }
            /* Tabela em Cards no Mobile */
            .table thead { display: none; }
            .table tr { display: block; margin-bottom: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #eee; }
            .table td { display: block; text-align: right; border-bottom: 1px solid #f0f0f0; position: relative; padding-left: 35%; padding-top: 10px; padding-bottom: 10px; }
            .table td::before { content: attr(data-label); position: absolute; left: 15px; font-weight: bold; color: #666; text-transform: uppercase; font-size: 0.75rem; top: 12px; text-align: left; width: 30%; }
            .table td:last-child { border-bottom: none; text-align: center; padding-left: 0; background-color: #fcfcfc; }
            .btn-copy-wrapper { justify-content: flex-end; }
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-top shadow-sm sticky-top">
        <div class="container-fluid navbar-container d-flex justify-content-between align-items-center position-relative">
            <span class="navbar-brand text-white fw-bold fs-6"><i class="bi bi-shield-lock-fill"></i> NIO INTERNO</span>
            
            <div class="navbar-menu-center">
                <a class="nav-link-custom active" href="painel.html">Pedidos</a>
                <a class="nav-link-custom" href="referencias.html">Refer√™ncias</a>
                <a class="nav-link-custom" href="relatorios.html">Relat√≥rios</a>
            </div>

            <div class="d-flex align-items-center">
                <span class="me-2 text-white small d-none d-sm-inline">Ol√°, <strong id="nomeUsuario">...</strong></span>
                <button onclick="sair()" class="btn btn-sm btn-outline-light"><i class="bi bi-box-arrow-right"></i> Sair</button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="fw-bold text-secondary m-0">Gest√£o de Pedidos</h4>
                <div class="d-flex align-items-center gap-2">
                    <small class="text-muted" id="statusAuto">Aguardando atualiza√ß√£o...</small>
                </div>
            </div>
            <button class="btn btn-success fw-bold shadow-sm px-3 py-2" onclick="abrirModalNovo()">
                <i class="bi bi-plus-lg"></i> <span class="d-none d-sm-inline ms-1">Novo Pedido</span>
            </button>
        </div>

        <div class="row g-2 g-md-4 mb-4">
            <div class="col-6 col-md-3">
                <div class="card card-resumo bg-pendente shadow-sm" onclick="filtrarPorCard('EM AN√ÅLISE')">
                    <h3 id="totalAnalise">0</h3><small>Pendentes</small><i class="bi bi-hourglass-split icone-card"></i>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card card-resumo bg-atendido shadow-sm" onclick="filtrarPorCard('ATENDIDO')">
                    <h3 id="totalAtendidos">0</h3><small>Atendidos</small><i class="bi bi-check-circle icone-card"></i>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card card-resumo bg-nao-encontrado shadow-sm" onclick="filtrarPorCard('N√ÉO ENCONTRADO')">
                    <h3 id="totalNaoEnc">0</h3><small>N√£o Enc.</small><i class="bi bi-x-circle icone-card"></i>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card card-resumo bg-total shadow-sm" onclick="filtrarPorCard('TODOS')">
                    <h3 id="totalPedidos">0</h3><small>Total Geral</small><i class="bi bi-list-task icone-card"></i>
                </div>
            </div>
        </div>

        <div class="card shadow-sm border-0 mb-3">
            <div class="card-body p-2 p-md-3">
                <div class="row g-2 align-items-center">
                    <div class="col-12 col-md">
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                            <input type="text" id="inputPesquisa" class="form-control border-start-0" placeholder="Buscar por nome, ano ou assunto..." onkeyup="aplicarFiltros()">
                        </div>
                    </div>
                    <div class="col-8 col-md-auto">
                        <select id="filtroStatus" class="form-select w-100" onchange="aplicarFiltros()">
                            <option value="EM AN√ÅLISE" selected>‚ö†Ô∏è Mostrar Pendentes</option>
                            <option value="TODOS">üìã Mostrar Todos</option>
                            <option value="ATENDIDO">‚úÖ Mostrar Atendidos</option>
                            <option value="N√ÉO ENCONTRADO">‚ùå Mostrar N√£o Enc.</option>
                        </select>
                    </div>
                    <div class="col-4 col-md-auto">
                        <button onclick="carregarPedidos()" class="btn btn-primary w-100" title="For√ßar Atualiza√ß√£o">
                            <i class="bi bi-arrow-clockwise"></i> <span class="d-none d-md-inline">Atualizar</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="containerLista">
            <div class="table-responsive">
                <table class="table table-hover mb-0 bg-white shadow-sm rounded align-middle">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 100px;">Data</th>
                            <th style="width: 20%;">Solicitante</th>
                            <th style="width: 30%;">O que pesquisar?</th>
                            <th>Per√≠odo</th>
                            <th>Contato</th>
                            <th>Status</th>
                            <th>Resp.</th>
                            <th class="text-end" style="width: 160px;">A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaPedidos">
                        <tr><td colspan="8" class="text-center p-5"><div class="spinner-border text-primary"></div><br>Carregando dados...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="pagination-container bg-white p-3 rounded shadow-sm d-flex justify-content-between align-items-center mt-3 mb-5">
                <span class="text-muted small">P√°gina <span id="paginaAtual" class="fw-bold">1</span></span>
                <div>
                    <button class="btn btn-sm btn-outline-secondary me-1" onclick="mudarPagina(-1)"><i class="bi bi-chevron-left"></i> Ant.</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="mudarPagina(1)">Prox. <i class="bi bi-chevron-right"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modais -->
    <div class="modal fade" id="modalAtendimento" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Finalizar Atendimento</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editId">
                    <div class="mb-3">
                        <label class="fw-bold small text-muted">STATUS</label>
                        <select id="editStatus" class="form-select form-select-lg">
                            <option value="ATENDIDO">‚úÖ PEDIDO ATENDIDO</option>
                            <option value="N√ÉO ENCONTRADO">‚ùå N√ÉO ENCONTRADO</option>
                            <option value="EM AN√ÅLISE">‚ö†Ô∏è DEVOLVER PARA AN√ÅLISE</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold small text-muted">OBSERVA√á√ÉO DO T√âCNICO</label>
                        <textarea id="editRetorno" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary px-4" onclick="salvarAlteracao()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalNovoPedido" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Novo Pedido</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formNovoPedido">
                        <div class="mb-3">
                            <label class="fw-bold small text-muted">SOLICITANTE</label>
                            <input type="text" id="novoSolicitante" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="fw-bold small text-muted">O QUE PESQUISAR?</label>
                            <input type="text" id="novoPesquisa" class="form-control" required>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="fw-bold small text-muted">PER√çODO</label>
                                <input type="text" id="novoPeriodo" class="form-control" required>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="fw-bold small text-muted">WHATSAPP</label>
                                <input type="text" id="novoZap" class="form-control" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="fw-bold small text-muted">OBSERVA√á√ïES</label>
                            <textarea id="novoObs" class="form-control" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success px-4" onclick="salvarNovoPedido()">Cadastrar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const URL_API = 'https://script.google.com/macros/s/AKfycbwwEI9F6LFkqOqeoF4kKyARouJo-59C-34xhTWfL1bDD538muTldssosywD2G2CYyOpfA/exec';
        let dadosGlobais = [], dadosFiltrados = [], paginaAtual = 1;
        const itensPorPagina = 10;

        const usuarioLogado = localStorage.getItem('nio_usuario');
        if (!usuarioLogado) window.location.href = 'login.html';
        document.getElementById('nomeUsuario').innerText = usuarioLogado.split(' ')[0];
        
        function sair() { localStorage.clear(); window.location.href = 'login.html'; }
        
        $(document).ready(function(){ $('#novoZap').mask('(00) 00000-0000'); });

        function copiarTexto(texto, btn) {
            navigator.clipboard.writeText(texto).then(() => {
                const htmlOrig = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-check-lg"></i>';
                btn.classList.replace('btn-light', 'btn-success');
                btn.classList.replace('text-secondary', 'text-white');
                setTimeout(() => {
                    btn.innerHTML = htmlOrig;
                    btn.classList.replace('btn-success', 'btn-light');
                    btn.classList.replace('text-white', 'text-secondary');
                }, 1500);
            }).catch(() => alert('Erro ao copiar.'));
        }

        async function confirmarExclusao(id) {
            if (confirm("‚ö†Ô∏è TEM CERTEZA?\nIsso apagar√° o registro permanentemente.")) {
                const btn = document.querySelector(`button[onclick="confirmarExclusao('${id}')"]`);
                if(btn) btn.closest('tr').style.opacity = '0.3';

                try {
                    await fetch(URL_API, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ acao: 'excluir_pedido', id: id }) });
                    
                    const cacheLocal = localStorage.getItem('nio_pedidos_cache');
                    if(cacheLocal) {
                        let dados = JSON.parse(cacheLocal);
                        dados = dados.filter(item => item[0].toString() !== id.toString());
                        localStorage.setItem('nio_pedidos_cache', JSON.stringify(dados));
                        dadosGlobais = dados;
                        atualizarContadores(dadosGlobais);
                        aplicarFiltros();
                    } else { carregarPedidos(); }
                } catch (e) { alert('Erro ao excluir.'); if(btn) btn.closest('tr').style.opacity = '1'; }
            }
        }

        async function carregarPedidos() {
            const tbody = document.getElementById('tabelaPedidos');
            const statusDiv = document.getElementById('statusAuto');
            
            const cacheLocal = localStorage.getItem('nio_pedidos_cache');
            let carregouCache = false;

            if (cacheLocal) {
                try {
                    const dadosCache = JSON.parse(cacheLocal);
                    if(dadosCache.length > 0) {
                        dadosGlobais = dadosCache;
                        atualizarContadores(dadosGlobais);
                        aplicarFiltros();
                        carregouCache = true;
                    }
                } catch (e) { localStorage.removeItem('nio_pedidos_cache'); }
            }

            if (!carregouCache) tbody.innerHTML = '<tr><td colspan="8" class="text-center p-5"><div class="spinner-border text-primary"></div><br>Buscando dados...</td></tr>';
            statusDiv.innerHTML = '<span class="spinner-grow spinner-grow-sm text-success"></span> Atualizando...';

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000);

            try {
                const response = await fetch(URL_API + '?acao=listar_pedidos', { signal: controller.signal });
                const data = await response.json();
                
                if (data.result === 'success') {
                    const dadosNovosString = JSON.stringify(data.pedidos);
                    if (dadosNovosString !== cacheLocal) {
                        dadosGlobais = data.pedidos;
                        localStorage.setItem('nio_pedidos_cache', dadosNovosString);
                        atualizarContadores(dadosGlobais);
                        aplicarFiltros();
                    }
                    statusDiv.innerText = 'Atualiza√ß√£o autom√°tica ativa';
                }
            } catch (error) {
                console.error("Erro rede:", error);
                statusDiv.innerText = 'Offline - Verificando conex√£o...';
                if (!carregouCache) tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger p-4"><i class="bi bi-wifi-off fs-1"></i><br>Erro de conex√£o.</td></tr>';
            } finally { clearTimeout(timeoutId); }
        }

        function filtrarPorCard(status) { document.getElementById('filtroStatus').value = status; aplicarFiltros(); }

        function aplicarFiltros() {
            const termo = document.getElementById('inputPesquisa').value.toLowerCase();
            const status = document.getElementById('filtroStatus').value;
            dadosFiltrados = dadosGlobais.filter(p => {
                const matchTexto = String(p[2]).toLowerCase().includes(termo) || String(p[3]).toLowerCase().includes(termo) || String(p[4]).includes(termo);
                const matchStatus = status === 'TODOS' || p[6] === status;
                return matchTexto && matchStatus;
            });
            paginaAtual = 1;
            renderizarTabela();
        }

        function renderizarTabela() {
            const tbody = document.getElementById('tabelaPedidos');
            tbody.innerHTML = '';
            
            if(dadosFiltrados.length === 0) { tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted p-5 fs-5">Nenhum pedido encontrado.</td></tr>'; return; }

            const inicio = (paginaAtual - 1) * itensPorPagina;
            const fim = inicio + itensPorPagina;
            const paginaDados = dadosFiltrados.slice(inicio, fim);
            document.getElementById('paginaAtual').innerText = paginaAtual;

            paginaDados.forEach(p => {
                let badgeClass = 'bg-secondary';
                if(p[6] === 'EM AN√ÅLISE') badgeClass = 'bg-warning text-dark';
                else if(p[6] === 'ATENDIDO') badgeClass = 'bg-success';
                else if(p[6] === 'N√ÉO ENCONTRADO') badgeClass = 'bg-danger';

                let zap = p[5] ? `https://wa.me/55${p[5].toString().replace(/\D/g,'')}` : '#';
                let textoPesquisa = p[3] || "";
                let textoSafe = textoPesquisa.replace(/'/g, "\\'").replace(/"/g, '&quot;');

                tbody.innerHTML += `<tr>
                    <td data-label="Data" class="text-muted small">${p[1]}</td>
                    <td data-label="Solicitante" class="fw-bold text-primary">${p[2]}</td>
                    <td data-label="Pesquisa">
                        <div class="d-flex align-items-start justify-content-between bg-light p-2 rounded btn-copy-wrapper">
                            <span class="text-wrap me-2" style="word-break: break-word;">${textoPesquisa}</span>
                            <button class="btn btn-light btn-sm text-secondary border shadow-sm" onclick="copiarTexto('${textoSafe}', this)" title="Copiar"><i class="bi bi-clipboard"></i></button>
                        </div>
                    </td>
                    <td data-label="Per√≠odo">${p[4]}</td>
                    <td data-label="Contato"><a href="${zap}" target="_blank" class="btn btn-outline-success btn-sm border-0 rounded-circle"><i class="bi bi-whatsapp"></i></a></td>
                    <td data-label="Status"><span class="badge ${badgeClass} rounded-pill">${p[6]}</span></td>
                    <td data-label="Resp."><small class="text-secondary">${p[7]}</small></td>
                    <td data-label="A√ß√£o" class="text-end">
                        <div class="d-flex justify-content-end gap-2">
                            <button class="btn btn-outline-danger btn-sm rounded-pill px-2" onclick="confirmarExclusao('${p[0]}')" title="Excluir"><i class="bi bi-trash"></i></button>
                            <button class="btn btn-primary btn-sm rounded-pill px-3" onclick="abrirModal('${p[0]}','${p[6]}')">Atender</button>
                        </div>
                    </td>
                </tr>`;
            });
        }

        function mudarPagina(d) {
            const total = Math.ceil(dadosFiltrados.length / itensPorPagina);
            const nova = paginaAtual + d;
            if (nova >= 1 && nova <= total) { paginaAtual = nova; renderizarTabela(); if(window.innerWidth < 992) document.getElementById('containerLista').scrollIntoView({behavior: 'smooth'}); }
        }

        function atualizarContadores(lista) {
            document.getElementById('totalPedidos').innerText = lista.length;
            document.getElementById('totalAnalise').innerText = lista.filter(p => p[6] === 'EM AN√ÅLISE').length;
            document.getElementById('totalAtendidos').innerText = lista.filter(p => p[6] === 'ATENDIDO').length;
            document.getElementById('totalNaoEnc').innerText = lista.filter(p => p[6] === 'N√ÉO ENCONTRADO').length;
        }

        const modalAtendimento = new bootstrap.Modal(document.getElementById('modalAtendimento'));
        function abrirModal(id, st) { document.getElementById('editId').value = id; document.getElementById('editStatus').value = st; document.getElementById('editRetorno').value = ''; modalAtendimento.show(); }

        async function salvarAlteracao() {
            const id = document.getElementById('editId').value, st = document.getElementById('editStatus').value, ret = document.getElementById('editRetorno').value, resp = localStorage.getItem('nio_usuario');
            const btn = document.querySelector('#modalAtendimento .btn-primary'), txtOrig = btn.innerText;
            btn.innerText = 'Salvando...'; btn.disabled = true;
            try { await fetch(URL_API, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({acao: 'atualizar_pedido', id: id, status: st, retorno: ret, responsavel: resp}) }); alert('Atualizado!'); modalAtendimento.hide(); carregarPedidos(); } catch(e) { alert('Erro.'); } finally { btn.innerText = txtOrig; btn.disabled = false; }
        }

        const modalNovo = new bootstrap.Modal(document.getElementById('modalNovoPedido'));
        function abrirModalNovo() { document.getElementById('formNovoPedido').reset(); modalNovo.show(); }

        async function salvarNovoPedido() {
            const form = { acao: 'novo_pedido', solicitante: document.getElementById('novoSolicitante').value, nome_pesquisado: document.getElementById('novoPesquisa').value, periodo: document.getElementById('novoPeriodo').value, whatsapp: document.getElementById('novoZap').value, observacoes: document.getElementById('novoObs').value, responsavel: localStorage.getItem('nio_usuario') };
            if(!form.solicitante) return alert('Preencha os campos.');
            const btn = document.querySelector('#modalNovoPedido .btn-success'), txtOrig = btn.innerText;
            btn.innerText = 'Enviando...'; btn.disabled = true;
            try { await fetch(URL_API, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(form) }); alert('Cadastrado!'); modalNovo.hide(); carregarPedidos(); } catch(e) { alert('Erro.'); } finally { btn.innerText = txtOrig; btn.disabled = false; }
        }

        window.onload = function() { carregarPedidos(); setInterval(() => carregarPedidos(), 30000); };
    </script>
</body>
</html>